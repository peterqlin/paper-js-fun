<!DOCTYPE html>
<html>

<head>
  <title>Peter Lin</title>
  <!-- <link rel="icon" type="image/png" href="favicon.ico"> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.17/paper-full.min.js"></script>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #f0f0f0;
    }

    #paper-canvas-container {
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #paper-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>

<body>

  <script type="text/javascript">
    // inspired by koalastothemax.com
    document.addEventListener('DOMContentLoaded', () => {
      const canvas = document.getElementById('paper-canvas');
      paper.setup(canvas);
      // paper.install(window);
      // paper.setup(document.createElement('canvas'));
      // document.body.appendChild(paper.view.element);

      paper.view.viewSize = new paper.Size(window.innerWidth, window.innerHeight);

      var viewWidth = 1528; // hardcoded lol
      var viewHeight = 708;

      var raster = new paper.Raster('amongus.jpg');
      var loaded = false;
      raster.on('load', () => {
        loaded = true;
        init();
      });

      function moveHandler(event, refCenter, radius) {
        if (!loaded || radius < 4)
          return;

        event.target.remove();

        var tempCircle = new paper.Path.Circle({
          center: refCenter,
          radius: radius,
          fillColor: raster.getAverageColor(new paper.Rectangle(refCenter.subtract([radius, radius]), new paper.Size(radius * 2, radius * 2))),
          applyMatrix: false
        });
        tempCircle.tweenTo(
          { opacity: 0 },
          {
            duration: 250,
            easing: 'easeInOutQuad'
          }
        );
        setTimeout(() => {
          tempCircle.remove();
        }, 250);

        radius /= 2;

        var positions = [
          refCenter.add(new paper.Point(-radius, -radius)),
          refCenter.add(new paper.Point(-radius, radius)),
          refCenter.add(new paper.Point(radius, -radius)),
          refCenter.add(new paper.Point(radius, radius)),
        ];

        var circles = positions.map(pos => {
          var circle = new paper.Path.Circle({
            center: refCenter,
            radius: radius,
            fillColor: raster.getAverageColor(new paper.Rectangle(pos.subtract([radius, radius]), new paper.Size(radius * 2, radius * 2))),
            onMouseMove: (event) => moveHandler(event, pos, radius)
          });

          circle.tweenTo(
            { position: pos },
            {
              duration: 250,
              easing: 'easeInOutQuad'
            }
          );

          return circle;
        });
      }

      function init(event) {
        paper.project.activeLayer.removeChildren();

        var width = getSmallestPowerOf2(Math.min(viewWidth, viewHeight));
        var radius = width / 2;

        var fitScreenScaleFactor = Math.max(viewWidth / raster.width, viewHeight / raster.height);
        var marginPercent = 1.05;
        var scaleFactor = Math.min(marginPercent * width / viewWidth, marginPercent * width / viewHeight);

        paper.view.viewSize = new paper.Size(window.innerWidth, window.innerHeight);
        // first scale to fit screen
        raster.scale(fitScreenScaleFactor, fitScreenScaleFactor);
        // then scale from the reference scale
        raster.scale(scaleFactor, scaleFactor);
        raster.position = new paper.Point(window.innerWidth / 2, window.innerHeight / 2);

        var circle = new paper.Path.Circle({
          center: paper.view.bounds.center,
          radius: radius,
          fillColor: raster.getAverageColor(paper.view.bounds),
          onMouseMove: (event) => moveHandler(event, new paper.Point(paper.view.bounds.center.x, paper.view.bounds.center.y), radius),
          applyMatrix: false
        });

        // enlarge circle and fade in upon first loading
        circle.tween(
          { opacity: 0, scaling: 0.0001 },
          { opacity: 1, scaling: 1 },
          {
            duration: 500,
            easing: 'easeInOutQuad'
          }
        );
      }

      // ensure clean splits and no rounding needed
      function getSmallestPowerOf2(limit) {
        var exp = 0;
        while (Math.pow(2, exp) < limit) {
          exp++;
        }
        return Math.pow(2, exp - 1);
      }
    });
  </script>
  <div id="paper-canvas-container">
    <canvas id="paper-canvas" resize></canvas>
  </div>
</body>

</html>